<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body { font-family: Arial, sans-serif; background: #fffce0; text-align: center; padding: 50px; }
      h1 { color: #c00; }
      .slot-machine-wrapper { display: flex; justify-content: center; align-items: center; gap: 30px; }
      .reel-box { width: 200px; height: 60px; border: 3px solid #000; border-radius: 10px; background: #fff; font-size: 20px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
      button { margin: 10px; padding: 10px 20px; font-size: 16px; background-color: #ff9900; color: white; border: none; border-radius: 10px; cursor: pointer; }
      #resetHistoryButton { background-color: #666; }
      #restartButton { background-color: #0066cc; }
      #result, #history { margin-top: 30px; }
      #history { text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; padding: 15px; border-radius: 10px; border: 1px solid #ccc; }
    </style>
  </head>
  <body>
    <h1>ğŸ° å€åŸŸæ‹‰éœ¸æ©Ÿ</h1>
    <div class="slot-machine-wrapper">
      <div id="areaReel" class="reel-box">--</div>
      <div id="numberReel" class="reel-box">--</div>
    </div>
    <button id="drawButton" onclick="startDraw()">é–‹å§‹æŠ½é¸</button>
    <button id="retryNumberButton" onclick="retryNumber()" disabled>é‡æŠ½ç›®å‰ç·¨è™Ÿ</button>
    <button id="resetHistoryButton" onclick="resetHistory()">æ¸…é™¤ç´€éŒ„</button>
    <button id="restartButton" onclick="restartAll()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    <div id="result"></div>
    <div id="history"><strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
      let areaMap = {}, areaNames = [], drawnMap = {}, lastSelectedArea = null;

      window.onload = () => {
        Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vR_QEMI5Ad4r6uyqimM-HAO5q1cWQDylJjk_2WeJi19Aa7bogkQi3ZxhMGA-hQHuNq61OFVdENmsYqo/pub?gid=0&single=true&output=csv', {
          download: true, header: true, dynamicTyping: true, complete: function(results) { processCSVData(results.data); }
        });
      };

      function processCSVData(data) {
        areaMap = {};
        areaNames = [];
        data.forEach(row => {
          if (!areaMap[row.area]) {
            areaMap[row.area] = [];
            areaNames.push(row.area);
          }
          areaMap[row.area].push(row.number);
        });
      }

      function startDraw() {
        toggleButtons(true);
        spinAreaFirst();
      }

      function spinAreaFirst() {
        const availableAreas = areaNames.filter(area => drawnMap[area]?.length < areaMap[area]?.length);
        if (availableAreas.length === 0) return alert("æ‰€æœ‰å€åŸŸç·¨è™Ÿéƒ½æŠ½å®Œäº†ï¼");
        const areaReel = document.getElementById('areaReel');
        animateSpin(areaReel, availableAreas, () => {
          const finalArea = availableAreas[Math.floor(Math.random() * availableAreas.length)];
          areaReel.innerText = finalArea;
          lastSelectedArea = finalArea;
          spinNumber(finalArea);
        });
      }

      function spinNumber(area) {
        const remainingNumbers = areaMap[area].filter(n => !drawnMap[area]?.includes(n));
        if (remainingNumbers.length === 0) {
          document.getElementById('numberReel').innerText = 'å·²æŠ½å®Œ';
          return toggleButtons(false);
        }
        animateSpin(document.getElementById('numberReel'), remainingNumbers, () => {
          const finalNumber = remainingNumbers[Math.floor(Math.random() * remainingNumbers.length)];
          drawnMap[area] = drawnMap[area] || [];
          drawnMap[area].push(finalNumber);
          document.getElementById('result').innerHTML = `ğŸ‘‰ é¸ä¸­å€åŸŸï¼š<b>${area}</b><br>ğŸ‘‰ å€ç·¨è™Ÿï¼š<b>${finalNumber}</b>`;
          document.getElementById('history').innerHTML += `<div>ğŸ”¹ <b>${area}</b> - ç·¨è™Ÿï¼š<b>${finalNumber}</b></div>`;
          toggleButtons(false);
        });
      }

      function animateSpin(element, items, callback) {
        let start = null, duration = 2000 + Math.random() * 1000;
        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % items.length;
          element.innerText = items[i];
          if (progress < duration) requestAnimationFrame(animate);
          else callback();
        }
        requestAnimationFrame(animate);
      }

      function retryNumber() {
        if (!lastSelectedArea) return alert("è«‹å…ˆæŠ½å‡ºä¸€å€‹å€åŸŸï¼");
        toggleButtons(true);
        spinNumber(lastSelectedArea);
      }

      function toggleButtons(disabled) {
        document.getElementById('drawButton').disabled = disabled;
        document.getElementById('retryNumberButton').disabled = disabled;
      }

      function resetHistory() {
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
      }

      function restartAll() {
        drawnMap = {};
        lastSelectedArea = null;
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('result').innerHTML = '';
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
        toggleButtons(false);
        alert("æ‰€æœ‰è³‡æ–™å·²é‡ç½®ï¼");
      }
    </script>
  </body>
</html>
