<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #fffce0;
        text-align: center;
        padding: 50px;
      }

      h1 {
        color: #c00;
      }

      .slot-machine-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 40px;
        gap: 30px;
      }

      .reel-box {
        width: 200px;
        height: 60px;
        border: 3px solid #000;
        border-radius: 10px;
        background: #fff;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      button {
        margin: 10px;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ff9900;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
      }

      #resetHistoryButton {
        background-color: #666;
      }

      #restartButton {
        background-color: #0066cc;
      }

      #result {
        margin-top: 30px;
        font-size: 18px;
        color: #333;
      }

      #history {
        margin-top: 40px;
        text-align: left;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-height: 100px;
      }

      #history div {
        margin-bottom: 5px;
      }

      #result b {
        color: #003366;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ° å€åŸŸæ‹‰éœ¸æ©Ÿ</h1>

    <div class="slot-machine-wrapper">
      <div id="areaReel" class="reel-box">--</div>
      <div id="numberReel" class="reel-box">--</div>
    </div>

    <button id="drawButton" onclick="startDraw()">é–‹å§‹æŠ½é¸</button>
    <button id="retryNumberButton" onclick="retryNumber()" disabled>é‡æŠ½ç›®å‰ç·¨è™Ÿ</button>
    <button id="resetHistoryButton" onclick="resetHistory()">æ¸…é™¤ç´€éŒ„</button>
    <button id="restartButton" onclick="restartAll()">ğŸ”„ é‡æ–°é–‹å§‹</button>

    <div id="result"></div>
    <div id="history"><strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong></div>

    <!-- Include PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
      let areaMap = {};
      let areaNames = [];
      let drawnMap = {};
      let lastSelectedArea = null;

      window.onload = () => {
        // Fetch the CSV from GitHub
        Papa.parse('https://raw.githubusercontent.com/yourusername/repository-name/main/data/areas.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          complete: function(results) {
            processCSVData(results.data);
          }
        });
      };

      function processCSVData(data) {
        // å‡è¨­ CSV è£¡é¢æœ‰å…©åˆ— "area" å’Œ "number"
        areaMap = {};
        areaNames = [];
        
        // æŒ‰ç…§å€åŸŸåˆ†çµ„ç·¨è™Ÿ
        data.forEach(row => {
          if (!areaMap[row.area]) {
            areaMap[row.area] = [];
            areaNames.push(row.area);
          }
          areaMap[row.area].push(row.number);
        });

        console.log(areaMap);
        console.log(areaNames);
      }

      function startDraw() {
        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;
        document.getElementById('result').innerHTML = '';
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        spinAreaFirst();
      }

      function spinAreaFirst() {
        const availableAreas = areaNames.filter(area => {
          if (!drawnMap[area]) return true;
          return drawnMap[area].length < areaMap[area].length;
        });

        if (availableAreas.length === 0) {
          alert("æ‰€æœ‰å€åŸŸç·¨è™Ÿéƒ½æŠ½å®Œäº†ï¼Œè«‹æŒ‰ã€Œé‡æ–°é–‹å§‹ã€é‡æ–°æŠ½é¸ï¼");
          document.getElementById('drawButton').disabled = false;
          return;
        }

        const areaReel = document.getElementById('areaReel');
        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % availableAreas.length;
          areaReel.innerText = availableAreas[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalArea = availableAreas[Math.floor(Math.random() * availableAreas.length)];
            areaReel.innerText = finalArea;
            lastSelectedArea = finalArea;
            spinNumber(finalArea);
          }
        }

        requestAnimationFrame(animate);
      }

      function spinNumber(area) {
        const allNumbers = areaMap[area];
        const numberReel = document.getElementById('numberReel');

        if (!allNumbers || allNumbers.length === 0) {
          numberReel.innerText = 'ç„¡è³‡æ–™';
          document.getElementById('drawButton').disabled = false;
          return;
        }

        if (!drawnMap[area]) drawnMap[area] = [];

        const remainingNumbers = allNumbers.filter(n => !drawnMap[area].includes(n));

        if (remainingNumbers.length === 0) {
          numberReel.innerText = 'å·²æŠ½å®Œ';
          document.getElementById('result').innerHTML = `âš ï¸ <b>${area}</b> çš„ç·¨è™Ÿå·²å…¨éƒ¨æŠ½å®Œï¼Œè«‹æŒ‰ã€Œé‡æ–°é–‹å§‹ã€é‡ç½®`;
          document.getElementById('drawButton').disabled = false;
          document.getElementById('retryNumberButton').disabled = true;
          return;
        }

        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % remainingNumbers.length;
          numberReel.innerText = remainingNumbers[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalNumber = remainingNumbers[Math.floor(Math.random() * remainingNumbers.length)];
            numberReel.innerText = finalNumber;
            drawnMap[area].push(finalNumber);

            document.getElementById('result').innerHTML = `
              ğŸ‘‰ é¸ä¸­å€åŸŸï¼š<b>${area}</b><br>
              ğŸ‘‰ å€ç·¨è™Ÿï¼š<b>${finalNumber}</b>
            `;

            document.getElementById('history').innerHTML += `
              <div>ğŸ”¹ <b>${area}</b> - ç·¨è™Ÿï¼š<b>${finalNumber}</b></div>
            `;

            document.getElementById('drawButton').disabled = false;
            document.getElementById('retryNumberButton').disabled = false;
          }
        }

        requestAnimationFrame(animate);
      }

      function retryNumber() {
        if (!lastSelectedArea) {
          alert("è«‹å…ˆæŠ½å‡ºä¸€å€‹å€åŸŸï¼");
          return;
        }
        document.getElementById('result').innerHTML = '';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;
        spinNumber(lastSelectedArea);
      }

      function resetHistory() {
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
      }

      function restartAll() {
        drawnMap = {};
        lastSelectedArea = null;
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('result').innerHTML = '';
        document.getElementById('history').innerHTML = '<strong>ğŸ¯ æŠ½é¸ç´€éŒ„ï¼š</strong>';
        document.getElementById('drawButton').disabled = false;
        document.getElementById('retryNumberButton').disabled = true;
        alert("æ‰€æœ‰è³‡æ–™å·²é‡ç½®ï¼Œé‡æ–°é–‹å§‹æŠ½é¸ï¼");
      }
    </script>
  </body>
</html>
