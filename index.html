<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>區域拉霸機</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #fffce0;
        text-align: center;
        padding: 50px;
        min-height: 100vh; /* 確保背景至少覆蓋整個視窗高度 */
        margin: 0; /* 移除預設邊距 */

        /* ======= 背景圖設定開始 ======= */
        background-image: url('./003.png'); /* 指定圖片路徑，假設圖片在 index.html 同一目錄 */
        background-repeat: no-repeat;       /* 背景圖片不重複 */
        background-position: center center; /* 圖片水平和垂直都置中 */
        background-attachment: fixed;       /* 讓背景圖固定，不隨頁面捲動而移動 */
        background-size: 300px 200px;       /* *** 在這裡設定圖片的固定寬度和高度 *** */
        /* ======= 背景圖設定結束 ======= */
      }

      h1 {
        color: #c00;
        margin-bottom: 40px;
      }

      .slot-machine-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 40px;
        gap: 30px;
      }

      .reel-box {
        width: 200px;
        height: 60px;
        border: 3px solid #000;
        border-radius: 10px;
        background: #fff;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2); /* 添加陰影增加立體感 */
      }

      button {
        margin: 10px;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ff9900;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease; /* 按鈕平滑過渡效果 */
      }

      button:hover {
        background-color: #e68a00; /* 按鈕懸停效果 */
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      #resetHistoryButton {
        background-color: #666;
      }
      #resetHistoryButton:hover {
        background-color: #555;
      }

      #restartButton {
        background-color: #0066cc;
      }
      #restartButton:hover {
        background-color: #005bb5;
      }

      #musicToggleButton {
        background-color: #4CAF50; /* 綠色 */
        position: fixed; /* 固定在螢幕上 */
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        font-size: 14px;
        z-index: 1000; /* 確保按鈕在其他內容之上 */
      }
      #musicToggleButton:hover {
        background-color: #45a049;
      }


      #result {
        margin-top: 30px;
        font-size: 18px;
        color: #333;
        min-height: 40px; /* 確保結果區有足夠高度，避免內容跳動 */
      }

      #result b {
        color: #003366;
      }

      #history {
        margin-top: 40px;
        text-align: left;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.8); /* 歷史紀錄區塊半透明，能看到背景圖 */
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-height: 100px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        overflow-y: auto; /* 紀錄多時可以捲動 */
        max-height: 250px; /* 設定最大高度 */
      }

      #history strong {
        color: #c00;
        display: block; /* 讓標題獨立一行 */
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      #history div {
        margin-bottom: 5px;
        padding-left: 10px;
        border-left: 3px solid #ff9900;
      }
    </style>
  </head>
  <body>
    <audio id="backgroundMusic" src="./002.mp3" loop preload="auto"></audio>
    <button id="musicToggleButton" onclick="toggleMusic()">🎵 音樂開 / 關</button>

    <h1>🎰 區域拉霸機</h1>

    <div class="slot-machine-wrapper">
      <div id="areaReel" class="reel-box">--</div>
      <div id="numberReel" class="reel-box">--</div>
    </div>

    <button id="drawButton" onclick="startDraw()">開始抽選</button>
    <button id="retryNumberButton" onclick="retryNumber()" disabled>重抽目前編號</button>
    <button id="resetHistoryButton" onclick="resetHistory()">清除紀錄</button>
    <button id="restartButton" onclick="restartAll()">🔄 重新開始</button>

    <div id="result"></div>
    <div id="history"><strong>🎯 抽選紀錄：</strong></div>

    <script>
      // ====================================================================
      // *** 這是根據您提供的最新資料生成的 `areaMap` 和 `areaNames` ***
      // ====================================================================
      let areaMap = {
        "大德": ["002區", "003區"],
        "中和": [
          "001區", "002區", "003區", "004區", "005區", "006區", "007區", "008區",
          "010區", "011區", "012區", "013區", "014區", "017區", "018區", "019區",
          "020區", "021區", "022區", "023區", "024區", "025區", "026區", "027區",
          "028區", "029區", "030區", "031區", "032區", "033區", "034區", "035區",
          "036區", "038區", "039區", "040區", "041區", "042區", "043區", "044區",
          "045區", "047區", "048區", "049區", "050區", "051區", "052區", "053區",
          "054區", "055區", "056區", "057區", "058區", "059區", "062區", "063區",
          "064區", "065區", "066區", "067區", "068區", "069區", "070區", "071區",
          "072區", "075區", "076區", "077區", "078區", "080區", "081區", "082區",
          "083區", "084區", "085區", "087區", "088區", "089區", "090區", "092區",
          "093區", "094區", "095區", "096區", "097區", "098區", "099區", "100區",
          "101區", "102區", "103區", "104區", "105區", "106區", "107區", "108區",
          "109區", "110區", "111區", "112區", "113區", "114區", "115區", "117區",
          "118區"
        ],
        "文化傳播": ["001區"],
        "正宗": ["001區", "002區", "003區", "005區", "006區", "007區", "008區"],
        "崇正區": [],
        "通化": ["001區", "002區", "003區", "005區"],
        "華德": ["001區", "002區", "003區", "004區", "005區", "006區"],
        "精明": ["001區", "002區", "011區", "013區", "018區", "022區", "024區"],
        "賢德": ["001區", "002區", "003區"]
      };

      let areaNames = [
        "大德", "中和", "文化傳播", "正宗", "崇正區", "通化", "華德", "精明", "賢德"
      ];

      // ====================================================================

      let drawnMap = {};
      let lastSelectedArea = null;
      let backgroundMusic = document.getElementById('backgroundMusic');
      let musicToggleBtn = document.getElementById('musicToggleButton');
      let isMusicPlaying = false; // 追蹤音樂播放狀態

      // 嘗試在網頁載入時播放音樂，但瀏覽器可能阻止
      // 為了解決自動播放限制，我們改用使用者互動來觸發播放
      // backgroundMusic.play().catch(error => {
      //     console.log('音樂自動播放被阻止:', error);
      //     // 如果自動播放被阻止，可以考慮給予使用者提示或顯示播放按鈕
      // });

      // 當使用者點擊「開始抽選」按鈕時，嘗試播放音樂（如果尚未播放）
      document.addEventListener('DOMContentLoaded', () => {
          // 首次載入時，音樂是靜音的，並顯示「音樂開」
          backgroundMusic.muted = true;
          musicToggleBtn.textContent = '🎵 音樂開';
      });

      function toggleMusic() {
          if (backgroundMusic.muted) {
              backgroundMusic.muted = false; // 取消靜音
              backgroundMusic.play().catch(error => {
                  console.log('音樂播放失敗:', error);
                  alert('瀏覽器限制自動播放音樂，請允許網站播放聲音。');
                  backgroundMusic.muted = true; // 如果播放失敗，再次靜音
                  musicToggleBtn.textContent = '🎵 音樂開';
              });
              musicToggleBtn.textContent = '🔇 音樂關';
              isMusicPlaying = true;
          } else {
              backgroundMusic.muted = true; // 靜音
              musicToggleBtn.textContent = '🎵 音樂開';
              isMusicPlaying = false;
          }
      }

      function startDraw() {
        // 如果音樂是靜音的，且播放功能允許，嘗試播放音樂
        if (backgroundMusic.muted) {
            backgroundMusic.muted = false; // 嘗試取消靜音
            backgroundMusic.play().catch(error => {
                console.log('音樂播放失敗 (抽籤時):', error);
                // 這裡不彈出提示，避免打斷使用者操作
            });
            musicToggleBtn.textContent = '🔇 音樂關';
            isMusicPlaying = true;
        }

        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;
        document.getElementById('result').innerHTML = '';
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        spinAreaFirst();
      }

      function spinAreaFirst() {
        const availableAreas = areaNames.filter(area => {
          if (!drawnMap[area]) return true;
          // 檢查是否還有未抽的號碼
          return areaMap[area].filter(n => !drawnMap[area].includes(n)).length > 0;
        });


        if (availableAreas.length === 0) {
          alert("所有區域編號都抽完了，請按「重新開始」重新抽選！");
          document.getElementById('drawButton').disabled = false;
          return;
        }

        const areaReel = document.getElementById('areaReel');
        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % availableAreas.length;
          areaReel.innerText = availableAreas[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalArea = availableAreas[Math.floor(Math.random() * availableAreas.length)];
            areaReel.innerText = finalArea;
            lastSelectedArea = finalArea;
            spinNumber(finalArea);
          }
        }

        requestAnimationFrame(animate);
      }

      function spinNumber(area) {
        const allNumbers = areaMap[area];
        const numberReel = document.getElementById('numberReel');

        if (!allNumbers || allNumbers.length === 0) {
          numberReel.innerText = '無資料';
          document.getElementById('result').innerHTML = `⚠️ <b>${area}</b> 沒有可抽取的編號。請按「重新開始」重置或選擇其他區域。`;
          document.getElementById('drawButton').disabled = false;
          document.getElementById('retryNumberButton').disabled = true;
          return;
        }

        if (!drawnMap[area]) drawnMap[area] = [];

        const remainingNumbers = allNumbers.filter(n => !drawnMap[area].includes(n));

        if (remainingNumbers.length === 0) {
          numberReel.innerText = '已抽完';
          document.getElementById('result').innerHTML = `⚠️ <b>${area}</b> 的編號已全部抽完，請按「重新開始」重置`;
          document.getElementById('drawButton').disabled = false;
          document.getElementById('retryNumberButton').disabled = true;
          return;
        }

        let spinDuration = 2000 + Math.random() * 1000;
        let start = null;

        function animate(time) {
          if (!start) start = time;
          const progress = time - start;
          const i = Math.floor(progress / 80) % remainingNumbers.length;
          numberReel.innerText = remainingNumbers[i];

          if (progress < spinDuration) {
            requestAnimationFrame(animate);
          } else {
            const finalNumber = remainingNumbers[Math.floor(Math.random() * remainingNumbers.length)];
            numberReel.innerText = finalNumber;
            drawnMap[area].push(finalNumber);

            document.getElementById('result').innerHTML = `
              👉 選中單位：<b>${area}</b><br>
              👉 區：<b>${finalNumber}</b>
            `;

            document.getElementById('history').innerHTML += `
              <div>🔹 <b>${area}</b> <b>${finalNumber}</b></div>
            `;

            document.getElementById('drawButton').disabled = false;
            document.getElementById('retryNumberButton').disabled = false;
          }
        }

        requestAnimationFrame(animate);
      }

      function retryNumber() {
        if (!lastSelectedArea) {
          alert("請先抽出一個區域！");
          return;
        }
        document.getElementById('result').innerHTML = '';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('drawButton').disabled = true;
        document.getElementById('retryNumberButton').disabled = true;
        spinNumber(lastSelectedArea);
      }

      function resetHistory() {
        document.getElementById('history').innerHTML = '<strong>🎯 抽選紀錄：</strong>';
      }

      function restartAll() {
        drawnMap = {};
        lastSelectedArea = null;
        document.getElementById('areaReel').innerText = '--';
        document.getElementById('numberReel').innerText = '--';
        document.getElementById('result').innerHTML = '';
        document.getElementById('history').innerHTML = '<strong>🎯 抽選紀錄：</strong>';
        document.getElementById('drawButton').disabled = false;
        document.getElementById('retryNumberButton').disabled = true;
        alert("所有資料已重置，重新開始抽選！");
      }
    </script>
  </body>
</html>
